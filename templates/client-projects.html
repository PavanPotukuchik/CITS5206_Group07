<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/client.css') }}" />
    <title>Client Dashboards</title>
    <style>
        .main-content {
            flex: 1;
            padding: 20px;
        }

        .card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                box-shadow: none;
            }

            .main-content {
                padding: 10px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="menu-btn">
                <i class="ph-bold ph-caret-left"></i>
            </div>
            <div class="head">
                <div class="user-img">
                    <img src="{{ url_for('static', filename='img/user.jpg') }}" alt="User" />
                </div>
                <div class="user-details">
                    <p class="title">Client</p>
                    <p class="name" id="username">Loading...</p>
                </div>
            </div>
            {% include 'client_menu.html' %}
        </div>
        <div class="main-content">
            <div class="content-area">
                <div class="card">
                    <h2>Project List</h2>
                    <table class="client-project-table">
                        <thead>
                            <tr>
                                <th>Project ID</th>
                                <th>Project Name</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody id="projectTableBody">
                            <!-- Projects will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/load-user.js') }}"></script>
    <script>
        const API_URL = 'http://127.0.0.1:8090';
        const PROJECT_COLLECTION = 'projects';

        async function loadProjects() {
            try {
                const response = await fetch(`${API_URL}/api/collections/${PROJECT_COLLECTION}/records`);
                const data = await response.json();

                if (response.ok) {
                    const data = await response.json();
                    const projectTableBody = document.getElementById('projectTableBody');

                    data.items.forEach(project => {
                        const row = document.createElement('tr');

                        row.innerHTML = `
                            <td>${project.id}</td>
                            <td>${project.projectName}</td>
                            <td>${project.projectStatus}</td>
                            <td>${new Date(project.created).toLocaleDateString()}</td>
                            <td>${new Date(project.updated).toLocaleDateString()}</td>
                        `;

                        row.addEventListener('click', () => {
                            window.location.href = `/project-detail-client?projectId=${project.id}`;
                        });

                        row.style.cursor = 'pointer';

                        projectTableBody.appendChild(row);
                    });

                } else {
                    console.error('Failed to load projects');
                }
            } catch (error) {
                console.error('Error fetching projects:', error);
            }
        }
        loadProjects();
        async function loadUserDetails() {
            const authData = JSON.parse(localStorage.getItem('client_auth'));
            if (authData && authData.record && authData.token) {
                try {
                    const response = await fetch(`${API_URL}/api/collections/users/records/${authData.record.id}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authData.token}`
                        }
                    });
                    if (response.ok) {
                        const user = await response.json();
                        document.getElementById('username').innerText = user.username;
                        const avatarUrl = user.avatar 
                            ? `${API_URL}/api/files/users/${user.id}/${user.avatar}` 
                            : "{{ url_for('static', filename='img/user.jpg') }}";
                        document.getElementById('user-avatar').src = avatarUrl;
    
                    } else {
                        console.error('Failed to load user details');
                    }
                } catch (error) {
                    console.error('Error fetching user details:', error);
                }
            } else {
                console.error('User is not authenticated');
            }
        }
        window.onload = loadUserDetails;
    </script>
</body>
</html>
